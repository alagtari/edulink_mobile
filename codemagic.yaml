workflows:
  staging-android-workflow:
    name: Android Staging Workflow
    instance_type: mac_mini_m1
    max_build_duration: 20
    environment:
      groups:
        - google_credentials
      flutter: "3.22.2"
      xcode: latest
      cocoapods: default
    triggering:
      events:
        - pull_request
      branch_patterns:
        - pattern: 'staging'
          include: true
    
    scripts:
      - name: Setup the keystore
        script: |
          echo $KEYSTORE_FILE | base64 --decode > /tmp/keystore.jks
          cat >> "$CM_BUILD_DIR/android/key.properties" << EOF
          storePassword=$KEYSTORE_PASSWORD
          keyPassword=$KEYSTORE_KEY_PASSWORD
          keyAlias=deployment
          storeFile=/tmp/keystore.jks
          EOF     
      - name: Build AAB
        script: |
          cd $CM_BUILD_DIR 
          flutter packages pub get
          flutter build appbundle
    artifacts:
      - build/**/outputs/**/*.aab
    publishing:
      google_play:
        credentials: $GOOGLE_PLAY_SERVICE_ACCOUNT
        track: alpha
  
  staging-ios-workflow:
    name: Ios Staging Workflow
    max_build_duration: 20
    instance_type: mac_mini_m1
    environment:
      ios_signing:
       distribution_type: app_store
       bundle_identifier: com.hakim.edulink
      flutter: "3.22.2"
      xcode: latest 
      vars:
        APP_ID: 6480532854
    cache:
      cache_paths:
        - ~/.pub-cache
    triggering:
      events:
        - pull_request
      branch_patterns:
        - pattern: 'staging'
          include: true
    scripts:
      - name: App version
        script: |
          # Extract version and build number from pubspec.yaml
          APP_VERSION=$(grep 'version:' pubspec.yaml | cut -d '+' -f 1 | awk '{print $2}')
          BUILD_NUMBER=$(grep 'build_number' pubspec.yaml | awk '{print $NF}')
          echo "App version: $APP_VERSION"
          echo "Build number: $BUILD_NUMBER"
      - name: Use the profile in xcode
        script: |
          xcode-project use-profiles
      - name: Get Flutter packages
        script: |
          flutter pub get
      - name: Pod install
        script: |
          find . -name "Podfile" -execdir pod install \;
      - name: Build IPA with Flutter
        script: | 
          # Build IPA with specific version and build number
          flutter build ipa --release \
            --build-name=$APP_VERSION \
            --build-number=$BUILD_NUMBER
      - name: Sign IPA with xcode
        script: |
          xcode-project build-ipa --workspace "ios/Runner.xcworkspace" --scheme "Runner"
    artifacts:
      - ./build/ios/ipa/*.ipa

    integrations:
      app_store_connect: Codemagic api key

    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
